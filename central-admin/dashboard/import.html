<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Student Database Import</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .import-card { background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .file-drop-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; text-align: center; background: #f8f9fa; }
        .file-drop-area.dragover { background: #e3f2fd; border-color: #2196f3; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="import-card p-5">
            <h2 class="text-center mb-4">üìä Import Student Database</h2>
            
            <div class="alert alert-info mb-4">
                <h5>üìã Step 1: Download Template</h5>
                <p>Download the CSV template to see the required format:</p>
                <a href="http://10.10.46.128:8000/api/download-template" class="btn btn-primary">
                    üì• Download CSV Template
                </a>
            </div>
            
            <div class="alert alert-warning mb-4">
                <h5>üì§ Step 2: Upload Your File</h5>
                <p><strong>Required Columns:</strong> Student ID, Name, Email, Date of Birth, Department, Year, Lab ID</p>
                <p><strong>Formats Supported:</strong> CSV (.csv), Excel (.xlsx, .xls)</p>
            </div>
            
            <form id="importForm" enctype="multipart/form-data">
                <div class="file-drop-area mb-4" id="fileDropArea">
                    <h4>üìÅ Drag & Drop your file here</h4>
                    <p class="text-muted">or click to browse</p>
                    <input type="file" id="studentFile" name="studentFile" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
                
                <div class="mb-3" id="fileInfo" style="display: none;">
                    <div class="alert alert-success">
                        <strong>File Selected:</strong> <span id="fileName"></span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="clearExisting" name="clearExisting">
                        <label class="form-check-label" for="clearExisting">
                            <strong>Clear existing students</strong> (‚ö†Ô∏è This will delete all current data)
                        </label>
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-success btn-lg" id="importBtn" disabled>
                        <span id="importText">üì§ Import Students</span>
                        <div class="spinner-border spinner-border-sm d-none" id="importSpinner"></div>
                    </button>
                </div>
            </form>
            
            <div id="importResults" class="mt-4" style="display: none;">
                <div class="alert" id="resultsAlert">
                    <h5>Import Results:</h5>
                    <div id="resultsContent"></div>
                </div>
            </div>
            
            <div class="mt-5">
                <h4>üìä Current Database</h4>
                <div id="dbStats" class="alert alert-light">Loading statistics...</div>
                <button class="btn btn-outline-primary" onclick="loadStats()">üîÑ Refresh Stats</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SERVER_URL = 'http://10.10.46.128:8000'; // FIXED IP
        
        const fileDropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('studentFile');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const importBtn = document.getElementById('importBtn');
        
        fileDropArea.addEventListener('click', () => fileInput.click());
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.classList.add('dragover');
        });
        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.classList.remove('dragover');
        });
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });
        
        function handleFile(file) {
            if (file) {
                fileName.textContent = file.name;
                fileInfo.style.display = 'block';
                importBtn.disabled = false;
            }
        }
        
        document.getElementById('importForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('studentFile', fileInput.files[0]);
            formData.append('clearExisting', document.getElementById('clearExisting').checked);
            
            setLoading(true);
            
            try {
                const response = await fetch(`${SERVER_URL}/api/import-students`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                showResults(result);
                loadStats();
                
            } catch (error) {
                showResults({ success: false, error: error.message });
            } finally {
                setLoading(false);
            }
        });
        
        function setLoading(loading) {
            const btn = document.getElementById('importBtn');
            const text = document.getElementById('importText');
            const spinner = document.getElementById('importSpinner');
            
            btn.disabled = loading;
            if (loading) {
                text.textContent = 'Importing...';
                spinner.classList.remove('d-none');
            } else {
                text.textContent = 'üì§ Import Students';
                spinner.classList.add('d-none');
            }
        }
        
        function showResults(result) {
            const resultsDiv = document.getElementById('importResults');
            const alert = document.getElementById('resultsAlert');
            const content = document.getElementById('resultsContent');
            
            if (result.success) {
                alert.className = 'alert alert-success';
                content.innerHTML = `
                    <strong>‚úÖ Import Successful!</strong><br>
                    üìä Total Processed: ${result.stats.totalProcessed}<br>
                    ‚úÖ Successfully Imported: ${result.stats.successful}<br>
                    ‚ùå Failed: ${result.stats.failed}<br>
                    ${result.stats.errors.length > 0 ? `<br><strong>Errors:</strong><br>${result.stats.errors.join('<br>')}` : ''}
                `;
            } else {
                alert.className = 'alert alert-danger';
                content.innerHTML = `<strong>‚ùå Import Failed:</strong><br>${result.error}`;
            }
            
            resultsDiv.style.display = 'block';
        }
        
        async function loadStats() {
            try {
                const response = await fetch(`${SERVER_URL}/api/stats`);
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('dbStats').innerHTML = `
                        <strong>Total Students:</strong> ${stats.totalStudents}<br>
                        <strong>Passwords Set:</strong> ${stats.passwordsSet}<br>
                        <strong>Pending First-time Signin:</strong> ${stats.pendingPasswords}<br>
                        <strong>Departments:</strong> ${stats.departments.map(d => `${d._id} (${d.count})`).join(', ')}
                    `;
                }
            } catch (error) {
                document.getElementById('dbStats').innerHTML = 'Error loading statistics';
            }
        }
        
        loadStats();
    </script>
</body>
</html>
