<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üîí College Lab Kiosk</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        body {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            min-height: 100vh;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            padding: 20px 0;
        }
        .kiosk-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
        }
        .card-header {
            border-radius: 20px 20px 0 0;
        }
        .lock-icon {
            font-size: 4rem;
        }
        .system-info {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(253, 126, 20, 0.1));
            border-left: 5px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .demo-section {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 9999;
        }
        .status-connected { background: #28a745; color: white; }
        .status-disconnected { background: #dc3545; color: white; }
        .demo-btn {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            font-weight: bold;
            margin: 5px;
        }
        .demo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        .btn-unlock {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px;
            width: 100%;
            color: white;
        }
        .btn-unlock:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(40, 167, 69, 0.4);
        }
        .btn-forgot {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            border: none;
            color: #000;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-forgot:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255, 193, 7, 0.4);
            color: #000;
        }
        .session-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .session-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }
        .session-icon {
            font-size: 6rem;
            color: #28a745;
        }
        .duration-display {
            font-size: 3rem;
            font-weight: bold;
            color: #28a745;
            font-family: 'Courier New', monospace;
        }
        .debug-section {
            background: rgba(108, 117, 125, 0.1);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .forgot-password-section {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(253, 126, 20, 0.1));
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status status-disconnected">
        <i class="fas fa-circle"></i> Disconnected
    </div>

    <div id="loginScreen" class="kiosk-container">
        <div class="login-card">
            <div class="card-header bg-danger text-white text-center py-4">
                <div class="lock-icon mb-3">
                    <i class="fas fa-lock"></i>
                </div>
                <h2 class="mb-0"><strong>üñ•Ô∏è College Lab Registration System</strong></h2>
                <p class="mb-0 mt-2">Secure Student Kiosk Access</p>
            </div>
            <div class="card-body p-4">
                <div class="system-info">
                    <h5 class="text-danger mb-3"><i class="fas fa-info-circle"></i> System Information</h5>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <strong>Computer Name:</strong> <span id="computerName">Loading...</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>Lab ID:</strong> <span class="badge bg-danger">LAB-01</span>
                        </div>
                        <div class="col-md-12 mb-2">
                            <strong>Current Time:</strong> <span id="currentTime" style="color: #28a745; font-weight: bold;">--:--:--</span>
                        </div>
                    </div>
                </div>

                <div class="demo-section">
                    <h5 class="text-success mb-3"><i class="fas fa-rocket"></i> Quick Demo Logins</h5>
                    <p class="text-muted small mb-3">Click any button below to auto-fill login credentials for demo</p>
                    <div class="d-flex justify-content-center flex-wrap">
                        <button class="btn demo-btn" onclick="fillDemo(1)">
                            <i class="fas fa-user"></i> Demo Student 1
                        </button>
                        <button class="btn demo-btn" onclick="fillDemo(2)">
                            <i class="fas fa-user"></i> Demo Student 2
                        </button>
                        <button class="btn demo-btn" onclick="fillDemo(3)">
                            <i class="fas fa-user"></i> Demo Student 3
                        </button>
                    </div>
                </div>

                <div id="errorAlert" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> <span id="errorMessage"></span>
                </div>

                <form id="loginForm">
                    <div class="mb-4">
                        <label class="form-label fw-bold"><i class="fas fa-user"></i> Student ID</label>
                        <input type="text" class="form-control form-control-lg" id="studentId" placeholder="Enter your Student ID" required />
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold"><i class="fas fa-key"></i> Password</label>
                        <input type="password" class="form-control form-control-lg" id="password" placeholder="Enter your Password" required />
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold"><i class="fas fa-desktop"></i> System Number</label>
                        <select class="form-select form-select-lg" id="systemNumber" required>
                            <option value="">Select System Number</option>
                            <option value="PC-01">PC-01</option>
                            <option value="PC-02">PC-02</option>
                            <option value="PC-03">PC-03</option>
                            <option value="PC-04">PC-04</option>
                            <option value="PC-05">PC-05</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-unlock btn-lg">
                        <i class="fas fa-unlock"></i> Unlock & Start Session
                    </button>
                    
                    <!-- NEW: Forgot Password Button -->
                    <button type="button" class="btn btn-forgot btn-lg mt-3 w-100" onclick="showForgotPassword()">
                        <i class="fas fa-key"></i> Forgot Password?
                    </button>
                </form>

                <!-- NEW: Forgot Password Info Section -->
                <div class="forgot-password-section">
                    <h6 class="text-warning mb-2"><i class="fas fa-lightbulb"></i> Forgot Password?</h6>
                    <p class="text-muted small mb-0">
                        If you forgot your password, click the button above and enter your <strong>Student ID</strong> 
                        and <strong>Date of Birth</strong> to reset your password. No phone required!
                    </p>
                </div>

                <div class="debug-section mt-4">
                    <h6 class="text-muted mb-2"><i class="fas fa-bug"></i> Debug Console</h6>
                    <div id="debugLog" style="color: #6c757d;">
                        System initialized. Waiting for login...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="sessionModal" class="session-modal">
        <div class="session-card">
            <div class="session-icon mb-4">
                <i class="fas fa-check-circle"></i>
            </div>
            <h1 class="mb-3 text-success"><strong>Session Active!</strong></h1>
            <h3 class="mb-4">Welcome, <span id="sessionStudentName" class="text-primary">Student</span>!</h3>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <h6 class="text-muted">Student ID</h6>
                    <p class="fw-bold" id="sessionStudentId">---</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted">System</h6>
                    <p class="fw-bold" id="sessionSystem">---</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted">Login Time</h6>
                    <p class="fw-bold" id="sessionLoginTime">---</p>
                </div>
            </div>

            <div class="bg-light p-4 rounded-3 mb-4">
                <h5 class="text-muted mb-2">Session Duration</h5>
                <div class="duration-display" id="sessionDuration">00:00:00</div>
            </div>

            <div class="alert alert-info mb-4">
                <i class="fas fa-video"></i> Your screen is being monitored by the admin dashboard.
            </div>

            <button class="btn btn-danger btn-lg px-5" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> End Session & Logout
            </button>
        </div>
    </div>

    <!-- CRITICAL: Load scripts in correct order at the END -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="renderer.js"></script>

    <script>
        // Demo login data
        const demoUsers = [
            { studentId: 'DEMO001', password: 'demo123', name: 'Rajesh Kumar' },
            { studentId: 'DEMO002', password: 'demo123', name: 'Priya Sharma' },
            { studentId: 'DEMO003', password: 'demo123', name: 'Arjun Patel' }
        ];

        // Fill demo login
        function fillDemo(num) {
            const user = demoUsers[num - 1];
            document.getElementById('studentId').value = user.studentId;
            document.getElementById('password').value = user.password;
            document.getElementById('systemNumber').value = 'PC-0' + num;
            addDebugLog(`Demo ${num} credentials filled: ${user.name}`);
        }

        let sessionStartTime = null;
        let durationInterval = null;
        let currentSessionId = null;

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        function addDebugLog(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `<br>[${timestamp}] ${message}`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        async function loadSystemInfo() {
            try {
                const sysInfo = await window.electronAPI.getSystemInfo();
                document.getElementById('computerName').textContent = sysInfo.hostname;
                addDebugLog(`System loaded: ${sysInfo.hostname}`);
            } catch (error) {
                console.error('Error loading system info:', error);
                addDebugLog(`Error: ${error.message}`);
            }
        }
        loadSystemInfo();

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            errorAlert.classList.add('d-none');

            const credentials = {
                studentId: document.getElementById('studentId').value.trim(),
                password: document.getElementById('password').value,
                systemNumber: document.getElementById('systemNumber').value,
            };

            addDebugLog(`Attempting login for ${credentials.studentId}...`);

            try {
                const result = await window.electronAPI.studentLogin(credentials);

                if (result.success) {
                    addDebugLog(`‚úÖ Login successful! Session: ${result.sessionId}`);
                    currentSessionId = result.sessionId;

                    document.getElementById('sessionStudentName').textContent = result.student.name;
                    document.getElementById('sessionStudentId').textContent = result.student.studentId;
                    document.getElementById('sessionSystem').textContent = credentials.systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();

                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('sessionModal').style.display = 'flex';

                    sessionStartTime = Date.now();
                    startDurationCounter();
                } else {
                    errorMessage.textContent = result.error || 'Login failed';
                    errorAlert.classList.remove('d-none');
                    addDebugLog(`‚ùå Login failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Login error:', error);
                errorMessage.textContent = 'An error occurred: ' + error.message;
                errorAlert.classList.remove('d-none');
                addDebugLog(`‚ùå Login error: ${error.message}`);
            }
        });

        function startDurationCounter() {
            durationInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
                const seconds = String(elapsed % 60).padStart(2, '0');
                document.getElementById('sessionDuration').textContent = `${hours}:${minutes}:${seconds}`;
            }, 1000);
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            addDebugLog('Logout initiated...');

            try {
                const result = await window.electronAPI.studentLogout();

                if (result.success) {
                    addDebugLog('‚úÖ Logout successful');

                    if (durationInterval) {
                        clearInterval(durationInterval);
                        durationInterval = null;
                    }

                    document.getElementById('loginForm').reset();
                    document.getElementById('sessionModal').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';

                    sessionStartTime = null;
                    currentSessionId = null;
                } else {
                    alert('Logout failed: ' + (result.error || 'Unknown error'));
                    addDebugLog(`‚ùå Logout failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout error: ' + error.message);
                addDebugLog(`‚ùå Logout error: ${error.message}`);
            }
        });

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status status-connected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Connected';
                addDebugLog('‚úÖ Socket connected');
            } else {
                statusEl.className = 'connection-status status-disconnected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Disconnected';
            }
        }

        updateConnectionStatus(false);

        // NEW: Forgot Password Functions
        function showForgotPassword() {
            addDebugLog('üîë Forgot password initiated');
            
            const studentId = prompt("üÜî Enter your Student ID:");
            if (!studentId) {
                addDebugLog('Forgot password cancelled - no student ID');
                return;
            }
            
            const dob = prompt(`üìÖ Enter your Date of Birth (YYYY-MM-DD format):

Example: 2001-05-15

This is your password reset code.`);
            if (!dob) {
                addDebugLog('Forgot password cancelled - no date of birth');
                return;
            }
            
            // Validate date format
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dob)) {
                alert("‚ùå Invalid date format!\n\nPlease use YYYY-MM-DD format\nExample: 2001-05-15");
                addDebugLog('Invalid date format provided');
                return;
            }
            
            const newPassword = prompt("üîí Enter new password (minimum 6 characters):");
            if (!newPassword || newPassword.length < 6) {
                alert("‚ùå Password must be at least 6 characters");
                addDebugLog('Invalid password provided');
                return;
            }
            
            const confirmPassword = prompt("üîí Confirm new password:");
            if (newPassword !== confirmPassword) {
                alert("‚ùå Passwords do not match");
                addDebugLog('Password confirmation failed');
                return;
            }
            
            // Call password reset API
            resetPassword(studentId.toUpperCase(), dob, newPassword);
        }

        async function resetPassword(studentId, dateOfBirth, newPassword) {
            addDebugLog(`üîÑ Attempting password reset for: ${studentId}`);
            
            try {
                const response = await fetch('http://localhost:8000/api/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, dateOfBirth, newPassword })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Password reset successful!

You can now login with your new password.

Student ID: ${studentId}
New Password: [Set successfully]

Click OK to continue.`);
                    
                    addDebugLog('‚úÖ Password reset completed successfully');
                    
                    // Auto-fill the student ID in login form
                    document.getElementById('studentId').value = studentId;
                    document.getElementById('password').focus();
                    
                    // Show success in debug log
                    addDebugLog(`Student ID auto-filled: ${studentId}`);
                    
                } else {
                    alert(`‚ùå Password reset failed:

Error: ${result.error}

Please check your details and try again.`);
                    addDebugLog(`‚ùå Password reset error: ${result.error}`);
                }
                
            } catch (error) {
                alert(`‚ùå Network error occurred:

${error.message}

Please ensure:
- Server is running
- Internet connection is stable
- Try again in a moment`);
                
                addDebugLog(`‚ùå Network error during password reset: ${error.message}`);
                console.error('Password reset network error:', error);
            }
        }

        // NEW: Add demo forgot password for testing
        function fillDemoForgotPassword() {
            alert(`üß™ Demo Forgot Password Test:

Use these demo credentials:
- Student ID: 2021CS001
- Date of Birth: 2001-05-15
- Set any new password

This will work with the sample database.`);
        }

        // Add keyboard shortcut for demo forgot password (Ctrl+F)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                fillDemoForgotPassword();
            }
        });
    </script>
</body>
</html>
